###############################################################################
#  Volumetric Flow Rate Testing for Sovol SV06 Plus
#
#  Purpose: Find maximum volumetric speed to optimize print speed
#
#  This macro helps you determine the maximum flow rate your hotend can handle
#  You'll then set PrusaSlicer to 80% of this maximum for reliable printing
#
#  Usage:
#  1. Heat hotend to your typical printing temperature
#  2. Run: FLOW_TEST TEMP=230 (or your temperature)
#  3. Watch the extrusion - when it starts to skip/grind, you've found the max
#  4. Calculate: max_volumetric_speed = flow_rate (from test)
#  5. Set in PrusaSlicer: Print Settings > Advanced > Max volumetric speed = max * 0.8
#
###############################################################################

[gcode_macro FLOW_TEST]
description: Test maximum volumetric flow rate. Usage: FLOW_TEST TEMP=230
gcode:
    # Parameters
    {% set TEMP = params.TEMP|default(230)|int %}
    {% set LENGTH = params.LENGTH|default(100)|int %}  # Length to extrude in mm

    {% set nozzle_diameter = printer.configfile.settings.extruder.nozzle_diameter|float %}

    RESPOND MSG="Starting Flow Rate Test"
    RESPOND MSG="Nozzle: {nozzle_diameter}mm"
    RESPOND MSG="Target Temp: {TEMP}°C"
    RESPOND MSG="Extrusion Length: {LENGTH}mm"

    # Safety checks
    {% if printer.toolhead.homed_axes != "xyz" %}
        RESPOND MSG="Homing first..."
        G28
    {% endif %}

    # Move to safe position
    G90
    G1 X150 Y150 Z50 F6000

    # Heat up
    RESPOND MSG="Heating to {TEMP}°C..."
    M109 S{TEMP}

    # Extrusion test
    RESPOND MSG="Starting extrusion test - watch for skipping/grinding"
    M83  # Relative extrusion

    # Test at different speeds
    {% set test_speeds = [2, 4, 6, 8, 10, 12, 15, 20, 25, 30] %}

    {% for speed in test_speeds %}
        {% set flow_rate = speed * (3.14159 * (nozzle_diameter/2) * (nozzle_diameter/2)) %}
        RESPOND MSG="Testing {speed}mm/s = {flow_rate|round(2)} mm³/s"
        G1 E{LENGTH/10} F{speed * 60}
        G4 P500  # Pause 500ms between tests
    {% endfor %}

    M82  # Absolute extrusion
    RESPOND MSG="Flow test complete!"
    RESPOND MSG="Find the speed where skipping started, then:"
    RESPOND MSG="1. Calculate max volumetric speed (shown above)"
    RESPOND MSG="2. Multiply by 0.8 for reliable speed"
    RESPOND MSG="3. Set in PrusaSlicer: Print Settings > Advanced > Max volumetric speed"

[gcode_macro MEASURE_FLOW_RATE]
description: Manual flow rate measurement. Usage: MEASURE_FLOW_RATE TEMP=230 SPEED=10
gcode:
    # Parameters
    {% set TEMP = params.TEMP|default(230)|int %}
    {% set SPEED = params.SPEED|default(10)|int %}  # mm/s extrusion speed
    {% set LENGTH = params.LENGTH|default(50)|int %}  # Length to extrude

    {% set nozzle_diameter = printer.configfile.settings.extruder.nozzle_diameter|float %}
    {% set filament_diameter = printer.configfile.settings.extruder.filament_diameter|float %}

    # Calculate volumetric flow
    {% set filament_area = 3.14159 * (filament_diameter/2) * (filament_diameter/2) %}
    {% set volumetric_speed = SPEED * filament_area %}

    RESPOND MSG="=== Flow Rate Test ==="
    RESPOND MSG="Temperature: {TEMP}°C"
    RESPOND MSG="Extrusion Speed: {SPEED}mm/s"
    RESPOND MSG="Volumetric Speed: {volumetric_speed|round(2)} mm³/s"
    RESPOND MSG="======================="

    # Safety
    {% if printer.toolhead.homed_axes != "xyz" %}
        G28
    {% endif %}

    # Move to center
    G90
    G1 X150 Y150 Z50 F6000

    # Heat and extrude
    M109 S{TEMP}
    M83
    RESPOND MSG="Extruding {LENGTH}mm at {SPEED}mm/s..."
    G1 E{LENGTH} F{SPEED * 60}
    RESPOND MSG="Done! Did it skip? If yes, reduce SPEED and try again."
    M82

###############################################################################
# QUICK REFERENCE: Typical Maximum Volumetric Speeds
#
# Stock SV06 Plus Hotend (E3D V6 style):
# - PLA: 11-15 mm³/s
# - PETG: 8-12 mm³/s
# - ABS: 10-14 mm³/s
#
# With High-Flow Hotend (CHT nozzle, etc):
# - PLA: 20-30 mm³/s
# - PETG: 15-20 mm³/s
#
# FORMULA:
# Volumetric Speed (mm³/s) = Print Speed (mm/s) × Layer Height (mm) × Line Width (mm)
#
# Example:
# If your max is 12 mm³/s, set PrusaSlicer to 12 × 0.8 = 9.6 mm³/s
#
# PRUSASLICER SETTINGS:
# Print Settings > Advanced > Max volumetric speed = 9.6
# This will automatically limit all speeds to ensure you never exceed this flow
#
###############################################################################
